<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¹ì‹ ë§Œì„ ìœ„í•œ ì—…ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="loader-container" class="fixed inset-0 bg-white bg-opacity-75 flex justify-center items-center z-50">
        <div class="loader"></div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl" id="content" style="display: none;">
        <nav class="bg-indigo-600 shadow-lg rounded-xl p-6 mb-8">
            <div class="text-2xl font-bold text-white text-center tracking-tight">ë‹¹ì‹ ì˜ ì„±ê³µì ì¸ ì„œë°”ì´ë²Œì„ ìœ„í•˜ì—¬ğŸ’ª</div>
        </nav>

        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>
            <button onclick="resetAllTasks()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300 shadow-md hover:shadow-lg">
                ì „ì²´ ì´ˆê¸°í™”
            </button>
        </div>

        <div class="text-lg mb-6">
            ì˜¤ëŠ˜ ë‚ ì§œ: <span class="font-semibold">{{ today }}</span>
            <span class="ml-4">ì˜¤ëŠ˜ì˜ í• ì¼: <span class="font-semibold">{{ completed_tasks|length }}/{{ total_tasks }}</span></span>
        </div>

        {% for category in tasks %}
        <div class="mb-8 p-6 bg-white shadow-lg rounded-xl hover:shadow-xl transition duration-300">
            <div class="text-2xl font-semibold mb-4 text-indigo-600">{{ category.category }}</div>
            {% for task in category.tasks %}
            <div class="ml-4 mb-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition duration-300">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-xl font-semibold mb-2">{{ task.title }}</div>
                        <div class="ml-4">
                            {% for step in task.steps %}
                            <div class="mb-2 text-gray-600">{{ step|safe }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <form method="POST" action="{{ url_for('complete_task') }}">
                        <input type="hidden" name="category" value="{{ category.category }}">
                        <input type="hidden" name="title" value="{{ task.title }}">
                        <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300">ì™„ë£Œ</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="mb-8 p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-indigo-600">í•´ì•¼í•  ì¼</h2>
            <form method="POST" action="{{ url_for('add_task') }}" class="flex items-center">
                <input type="text" name="title" class="border border-gray-300 p-2 rounded-lg flex-grow mr-4" placeholder="í• ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš” :)">
                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300">ì¶”ê°€</button>
            </form>
        </div>

        {% if additional_tasks %}
        <div class="mb-8 p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-indigo-600">í•´ì•¼í•  ì‘ì—…</h2>
            {% for task in additional_tasks %}
            <div class="ml-4 mb-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition duration-300">
                <div class="flex justify-between items-center">
                    <div class="text-xl font-semibold">{{ task.title }}</div>
                    <div>
                        <form method="POST" action="{{ url_for('complete_task') }}" class="inline">
                            <input type="hidden" name="category" value="ì¶”ê°€ëœ ì‘ì—…">
                            <input type="hidden" name="title" value="{{ task.title }}">
                            <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300 mr-2">ì™„ë£Œ</button>
                        </form>
                        <button onclick="confirmDelete('{{ task.title }}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-indigo-600">ì™„ë£Œëœ ì‘ì—…</h2>
                <button onclick="toggleCompletedTasks()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300">
                    ì™„ë£Œëœ ì‘ì—… ë³´ê¸°/ìˆ¨ê¸°ê¸°
                </button>
            </div>
            <div id="completedTasksContainer" class="p-6 bg-white shadow-lg rounded-xl">
                {% for task in completed_tasks %}
                <div class="mb-4 p-4 bg-gray-50 rounded-xl">
                    <div class="text-xl font-semibold mb-2">{{ task.category }} - {{ task.title }}</div>
                    <div class="text-gray-600">ì™„ë£Œ ì‹œê°„: {{ task.time }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="mb-8 p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-indigo-600">ì‘ì—… í†µê³„</h2>
            <canvas id="taskChart" width="400" height="200"></canvas>
        </div>

        <div class="text-xl font-semibold text-center p-4 bg-indigo-100 rounded-xl" id="completionMessage"></div>
    </div>

    <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <p class="text-lg mb-4">ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-end">
                <button id="cancelDelete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg mr-2 transition duration-300">ì·¨ì†Œ</button>
                <form method="POST" action="{{ url_for('delete_task') }}" id="deleteForm" class="inline">
                    <input type="hidden" name="title" id="deleteTaskTitle">
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300">ì‚­ì œ</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ì™„ë£Œëœ ì‘ì—… ì‹œê°„ ë°ì´í„°ë¥¼ ì „ë‹¬ë°›ê¸°
        var taskTimes = {{ task_times|tojson|safe }};
        
        // ì‹œê°„ì„ ì‹œê°„ëŒ€ë³„ë¡œ ê·¸ë£¹í™”
        function groupByHour(taskTimes) {
            var hours = Array(24).fill(0);
            taskTimes.forEach(function(time) {
                var hour = new Date(time).getHours();
                hours[hour]++;
            });
            return hours;
        }

        var hourlyData = groupByHour(taskTimes);

        // ì‹œê°„ëŒ€ë³„ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„ ìƒ‰ìƒì„ ë‹¤ë¥´ê²Œ ì§€ì •
        var colors = [
            'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 
            'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)',
            'rgba(199, 199, 199, 0.2)', 'rgba(83, 102, 255, 0.2)', 'rgba(159, 99, 132, 0.2)',
            'rgba(200, 162, 235, 0.2)', 'rgba(180, 206, 86, 0.2)', 'rgba(170, 192, 192, 0.2)',
            'rgba(100, 102, 255, 0.2)', 'rgba(150, 159, 64, 0.2)', 'rgba(200, 199, 199, 0.2)',
            'rgba(83, 199, 255, 0.2)', 'rgba(159, 159, 132, 0.2)', 'rgba(200, 200, 235, 0.2)',
            'rgba(180, 150, 86, 0.2)', 'rgba(170, 170, 192, 0.2)', 'rgba(100, 150, 255, 0.2)',
            'rgba(150, 100, 64, 0.2)', 'rgba(200, 150, 199, 0.2)', 'rgba(83, 150, 255, 0.2)'
        ];

        var borderColors = colors.map(color => color.replace('0.2', '1'));

        var ctx = document.getElementById('taskChart').getContext('2d');
        var taskChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (v, k) => k + ':00'),
                datasets: [{
                    label: 'ì™„ë£Œí•œ ì‘ì—…',
                    data: hourlyData,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                if (value % 1 === 0) {
                                    return value + 'ê±´';
                                }
                            },
                            stepSize: 1
                        },
                        max: Math.max(...hourlyData) + 1 // ë°ì´í„°ì˜ ìµœëŒ€ê°’ë³´ë‹¤ 1 í° ê°’ìœ¼ë¡œ ì„¤ì •
                    }
                }
            }
        });

        // ì™„ë£Œëœ ì‘ì—…ê³¼ ë¯¸ì™„ë£Œëœ ì‘ì—…ì˜ ìˆ˜ë¥¼ ê³„ì‚°
        var completedTasksCount = {{ completed_tasks|length }};
        var totalTasksCount = {{ total_tasks }};
        var incompleteTasksCount = totalTasksCount - completedTasksCount;

        // ë©”ì‹œì§€ í‘œì‹œ
        var messageElement = document.getElementById('completionMessage');
        if (completedTasksCount === 0) {
            messageElement.textContent = "í° ëª©í‘œë¥¼ ì´ë£¨ê³  ì‹¶ìœ¼ë©´ í—ˆë½ì„ êµ¬í•˜ì§€ ë§ˆë¼. â€“ ë¯¸ìƒ";
        } else if (completedTasksCount === 1) {
            messageElement.textContent = "ìƒí™©ì„ ê°€ì¥ ì˜ í™œìš©í•˜ëŠ” ì‚¬ëŒì´ ê°€ì¥ ì¢‹ì€ ìƒí™©ì„ ë§ëŠ”ë‹¤. â€“ ì¡´ ìš°ë“ ";
        } else if (completedTasksCount === 2) {
            messageElement.textContent = "ì°½ì¡°ì ì¸ ì‚¶ì„ ì‚´ë ¤ë©´ ë‚´ê°€ í‹€ë¦´ì§€ë„ ëª¨ë¥¸ë‹¤ëŠ” ê³µí¬ë¥¼ ë²„ë ¤ì•¼ í•œë‹¤. â€“ ë¯¸ìƒ";
        } else if (completedTasksCount === 3) {
            messageElement.textContent = "ì¼ë°˜ì ì¸ ê²ƒì„ ìƒì„ ìœ„í—˜ì„ ê°ìˆ˜í•˜ì§€ ì•Šìœ¼ë©´ í‰ë²”í•œ ê²ƒì— ë§Œì¡±í•´ì•¼ í•œë‹¤. â€“ ì§ ë¡ ";
        } else if (completedTasksCount === 4) {
            messageElement.textContent = "ì‹ ë¢°ì˜ ì´ìœ ëŠ” ì•ˆì „í•˜ê±°ë‚˜ í™•ì‹¤í•´ì„œê°€ ì•„ë‹ˆë¼, ìœ„í—˜ì„ ê°ìˆ˜í•  ìš©ì˜ê°€ ìˆì–´ì„œì´ë‹¤. â€“ ë¯¸ìƒ";
        } else if (completedTasksCount === 5) {
            messageElement.textContent = " í•œ ê°€ì§€ ìƒê°ì„ ì„ íƒí•˜ë¼. ê·¸ ìƒê°ì„ ë‹¹ì‹ ì˜ ì‚¶ìœ¼ë¡œ ë§Œë“¤ì–´ë¼. ê·¸ê±¸ ìƒê°í•˜ê³ , ê¿ˆê¾¸ê³ , ê·¸ì— ê¸°ë°˜í•´ì„œ ì‚´ì•„ê°€ë¼. ë‹¹ì‹ ì˜ ëª¸ì˜ ëª¨ë“  ë¶€ë¶„, ë‡Œ, ê·¼ìœ¡, ì‹ ê²½ì„ ê·¸ ìƒê°ìœ¼ë¡œ ê°€ë“ ì±„ìš°ê³  ë‹¤ë¥¸ ìƒê°ì€ ë‹¤ ë‚´ë²„ë ¤ë‘¬ë¼. ì´ê²ƒì´ ì„±ê³µí•˜ëŠ” ë°©ë²•ì´ë‹¤. â€“ ìŠ¤ì™€ë¯¸ ë¹„ë² ì¹´ë‚œë‹¤";
        } else if (completedTasksCount === 6) {
            messageElement.textContent = "ì¶”êµ¬í•  ìˆ˜ ìˆëŠ” ìš©ê¸°ê°€ ìˆë‹¤ë©´ ìš°ë¦¬ì˜ ëª¨ë“  ê¿ˆì€ ì´ë¤„ì§ˆ ìˆ˜ ìˆë‹¤. â€“ ì›”íŠ¸ ë””ì¦ˆë‹ˆ";
        } else if (completedTasksCount === 7) {
            messageElement.textContent = "ì°½ì¡°ì ì¸ ì‚¶ì„ ì‚´ë ¤ë©´ ë‚´ê°€ í‹€ë¦´ì§€ë„ ëª¨ë¥¸ë‹¤ëŠ” ê³µí¬ë¥¼ ë²„ë ¤ì•¼ í•œë‹¤. â€“ ë¯¸ìƒ";
        } else if (completedTasksCount === 8) {
            messageElement.textContent = "ê¸°ë‹¤ë¦¬ëŠ” ì‚¬ëŒì—ê²Œ ì¢‹ì€ ì¼ì´ ìƒê¸°ì§€ë§Œ, ì°¾ì•„ë‚˜ì„œëŠ” ì‚¬ëŒì—ê²ŒëŠ” ë” ì¢‹ì€ ì¼ì´ ìƒê¸´ë‹¤. â€“ ë¯¸ìƒ";
        } else if (completedTasksCount === 9) {
            messageElement.textContent = "ì°½ì¡°ì ì¸ ì‚¶ì„ ì‚´ë ¤ë©´ ë‚´ê°€ í‹€ë¦´ì§€ë„ ëª¨ë¥¸ë‹¤ëŠ” ê³µí¬ë¥¼ ë²„ë ¤ì•¼ í•œë‹¤. â€“ ë¯¸ìƒ";
        } else if (completedTasksCount === 10) {
            messageElement.textContent = "ëŠ˜ í•˜ë˜ ëŒ€ë¡œ í•˜ë©´ ëŠ˜ ì–»ë˜ ê²ƒì„ ì–»ëŠ”ë‹¤. â€“ ë¯¸ìƒ";
        } else if (completedTasksCount === 11) {
            messageElement.textContent = "ì—´ì •ì„ ìƒì§€ ì•Šê³  ì‹¤íŒ¨ì—ì„œ ì‹¤íŒ¨ë¡œ ê±¸ì–´ê°€ëŠ” ê²ƒì´ ì„±ê³µì´ë‹¤. â€“ ìœˆìŠ¤í„´ ì²˜ì¹ ";
        } else if (completedTasksCount === 12) {
            messageElement.textContent = "ì• ë²Œë ˆê°€ ì„¸ìƒì´ ëë‚¬ë‹¤ê³  ìƒê°í•˜ëŠ” ìˆœê°„ ë‚˜ë¹„ë¡œ ë³€í–ˆë‹¤. - ì†ë‹´";
        } else if (completedTasksCount === 13) {
            messageElement.textContent = "ì„±ê³µí•œ ì‚¬ì—…ê°€ë“¤ì€ ê¸ì •ì ì¸ ì—ë„ˆì§€ë¥¼ ì£¼ëŠ” ì‚¬ëŒë“¤ì´ì§€ ê°€ì ¸ê°€ëŠ” ì‚¬ëŒë“¤ì´ ì•„ë‹ˆë‹¤. â€“ ë¯¸ìƒ";
        } else if (completedTasksCount === 14) {
            messageElement.textContent = "ì„±ê³µí•œ ì‚¬ëŒì„ ë³¼ ë•Œ ë‹¹ì‹ ì€ ëŒ€ì¤‘ì—ê²Œ ë“œëŸ¬ë‚œ ì˜ì˜ˆë§Œ ë³´ì§€, ì ˆëŒ€ ê·¸ ì˜ì˜ˆë¥¼ ì–»ê¸° ìœ„í•´ í–ˆë˜ ê°œì¸ì  í¬ìƒì€ ë³´ì§€ ì•ŠëŠ”ë‹¤. â€“ ë°”ì…í•˜ë¸Œ ìƒ¤";
        } else if (completedTasksCount === 15) {
            messageElement.textContent = "ê¸°íšŒëŠ” ì¼ì–´ë‚˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë§Œë“¤ì–´ë‚´ëŠ” ê²ƒì´ë‹¤. â€“ í¬ë¦¬ìŠ¤ ê·¸ë¡œì„œ";
        } else if (completedTasksCount === 16) {
            messageElement.textContent = "ì„±ê³µí•œ ì‚¬ëŒì´ ë˜ë ¤ê³  ë…¸ë ¥í•˜ê¸°ë³´ë‹¤ ê°€ì¹˜ìˆëŠ” ì‚¬ëŒì´ ë˜ë ¤ê³  ë…¸ë ¥í•˜ë¼. â€“ ì•Œë²„íŠ¸ ì•„ì¸ìŠˆíƒ€ì¸";
        } else if (completedTasksCount === 17) {
            messageElement.textContent = "ìœ„ëŒ€í•œ ì •ì‹ ì„ ê°€ì§„ ì‚¬ëŒë“¤ì€ ìƒê°ì„ ë…¼í•œë‹¤. í‰ë²”í•œ ì‚¬ëŒë“¤ì€ ì‚¬ê±´ì„ ë…¼í•œë‹¤. ë§ˆìŒì´ ì¢ì€ ì‚¬ëŒë“¤ì€ ì‚¬ëŒë“¤ì„ ë…¼í•œë‹¤. â€“ ì—˜ë¦¬ë„ˆ ë£¨ì¦ˆë²¨íŠ¸";
        } else {
            messageElement.textContent = "í•  ì¼ì„ ëª¨ë‘ ëë‚´ì…¨êµ°ìš”! ê³ ìƒë§ìœ¼ì…¨ì–´ìš” :) ì˜¤ëŠ˜ í•˜ë£¨ë„ ë‹¹ì‹ ì´ ìˆì–´ì„œ ë¹›ë‚¬ì–´ìš”. ê³ ë§ˆì›Œìš”!";
        }

        // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ì°½ ê¸°ëŠ¥
        function confirmDelete(title) {
            document.getElementById('deleteTaskTitle').value = title;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        document.getElementById('cancelDelete').onclick = function() {
            document.getElementById('deleteModal').classList.add('hidden');
        };

        // 30ë¶„(1800ì´ˆ) í›„ì— ì•Œë¦¼ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        setTimeout(function() {
            alert("ì˜¤ë˜ ì•‰ì•„ìˆì—ˆìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë ˆì¹­ì„ í•´ì£¼ì„¸ìš”");
        }, 1800000); // 1800000ms = 30ë¶„

        // í˜ë“¤ë•Œ ë³´ëŠ” ê²ƒ í˜ì´ì§€ë¥¼ ìƒˆ ì°½ìœ¼ë¡œ ì—¬ëŠ” í•¨ìˆ˜
        function openRandomImage() {
            window.open('/random_image', '_blank', 'width=600,height=400');
        }

        // ì „ì²´ ì´ˆê¸°í™”í•˜ê¸° ê¸°ëŠ¥
        function resetAllTasks() {
            if (confirm("ëª¨ë“  ì‘ì—…ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                fetch('{{ url_for('reset_all_tasks') }}', {
                    method: 'POST',
                }).then(() => window.location.reload());
            }
        }

        // ì™„ë£Œëœ ì‘ì—… í† ê¸€ ê¸°ëŠ¥
        function toggleCompletedTasks() {
            const container = document.getElementById('completedTasksContainer');
            container.classList.toggle('hidden');
        }

        // í˜ì´ì§€ ë¡œë”©ì´ ì™„ë£Œë˜ë©´ ë¡œë”© ìŠ¤í”¼ë„ˆë¥¼ ìˆ¨ê¸°ê³  ì½˜í…ì¸ ë¥¼ í‘œì‹œ
        window.onload = function() {
            document.getElementById('loader-container').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }
    </script>
</body>
</html>