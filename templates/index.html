<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>당신만을 위한 업무 체크리스트</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="loader-container" class="fixed inset-0 bg-white bg-opacity-75 flex justify-center items-center z-50">
        <div class="loader"></div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl" id="content" style="display: none;">
        <nav class="bg-indigo-600 shadow-lg rounded-xl p-6 mb-8">
            <div class="text-2xl font-bold text-white text-center tracking-tight">당신의 성공적인 서바이벌을 위하여💪</div>
        </nav>

        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">체크리스트</h1>
            <button onclick="resetAllTasks()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300 shadow-md hover:shadow-lg">
                전체 초기화
            </button>
        </div>

        <div class="text-lg mb-6">
            오늘 날짜: <span class="font-semibold">{{ today }}</span>
            <span class="ml-4">오늘의 할일: <span class="font-semibold">{{ completed_tasks|length }}/{{ total_tasks }}</span></span>
        </div>

        {% for category in tasks %}
        <div class="mb-8 p-6 bg-white shadow-lg rounded-xl hover:shadow-xl transition duration-300">
            <div class="text-2xl font-semibold mb-4 text-indigo-600">{{ category.category }}</div>
            {% for task in category.tasks %}
            <div class="ml-4 mb-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition duration-300">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-xl font-semibold mb-2">{{ task.title }}</div>
                        <div class="ml-4">
                            {% for step in task.steps %}
                            <div class="mb-2 text-gray-600">{{ step|safe }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    <form method="POST" action="{{ url_for('complete_task') }}">
                        <input type="hidden" name="category" value="{{ category.category }}">
                        <input type="hidden" name="title" value="{{ task.title }}">
                        <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300">완료</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="mb-8 p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-indigo-600">해야할 일</h2>
            <form method="POST" action="{{ url_for('add_task') }}" class="flex items-center">
                <input type="text" name="title" class="border border-gray-300 p-2 rounded-lg flex-grow mr-4" placeholder="할일을 입력해주세요 :)">
                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300">추가</button>
            </form>
        </div>

        {% if additional_tasks %}
        <div class="mb-8 p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-indigo-600">해야할 작업</h2>
            {% for task in additional_tasks %}
            <div class="ml-4 mb-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition duration-300">
                <div class="flex justify-between items-center">
                    <div class="text-xl font-semibold">{{ task.title }}</div>
                    <div>
                        <form method="POST" action="{{ url_for('complete_task') }}" class="inline">
                            <input type="hidden" name="category" value="추가된 작업">
                            <input type="hidden" name="title" value="{{ task.title }}">
                            <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300 mr-2">완료</button>
                        </form>
                        <button onclick="confirmDelete('{{ task.title }}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300">삭제</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-indigo-600">완료된 작업</h2>
                <button onclick="toggleCompletedTasks()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition duration-300">
                    완료된 작업 보기/숨기기
                </button>
            </div>
            <div id="completedTasksContainer" class="p-6 bg-white shadow-lg rounded-xl">
                {% for task in completed_tasks %}
                <div class="mb-4 p-4 bg-gray-50 rounded-xl">
                    <div class="text-xl font-semibold mb-2">{{ task.category }} - {{ task.title }}</div>
                    <div class="text-gray-600">완료 시간: {{ task.time }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="mb-8 p-6 bg-white shadow-lg rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-indigo-600">작업 통계</h2>
            <canvas id="taskChart" width="400" height="200"></canvas>
        </div>

        <div class="text-xl font-semibold text-center p-4 bg-indigo-100 rounded-xl" id="completionMessage"></div>
    </div>

    <div id="deleteModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <p class="text-lg mb-4">정말로 삭제하시겠습니까?</p>
            <div class="flex justify-end">
                <button id="cancelDelete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg mr-2 transition duration-300">취소</button>
                <form method="POST" action="{{ url_for('delete_task') }}" id="deleteForm" class="inline">
                    <input type="hidden" name="title" id="deleteTaskTitle">
                    <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300">삭제</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 완료된 작업 시간 데이터를 전달받기
        var taskTimes = {{ task_times|tojson|safe }};
        
        // 시간을 시간대별로 그룹화
        function groupByHour(taskTimes) {
            var hours = Array(24).fill(0);
            taskTimes.forEach(function(time) {
                var hour = new Date(time).getHours();
                hours[hour]++;
            });
            return hours;
        }

        var hourlyData = groupByHour(taskTimes);

        // 시간대별로 막대 그래프 색상을 다르게 지정
        var colors = [
            'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 
            'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)',
            'rgba(199, 199, 199, 0.2)', 'rgba(83, 102, 255, 0.2)', 'rgba(159, 99, 132, 0.2)',
            'rgba(200, 162, 235, 0.2)', 'rgba(180, 206, 86, 0.2)', 'rgba(170, 192, 192, 0.2)',
            'rgba(100, 102, 255, 0.2)', 'rgba(150, 159, 64, 0.2)', 'rgba(200, 199, 199, 0.2)',
            'rgba(83, 199, 255, 0.2)', 'rgba(159, 159, 132, 0.2)', 'rgba(200, 200, 235, 0.2)',
            'rgba(180, 150, 86, 0.2)', 'rgba(170, 170, 192, 0.2)', 'rgba(100, 150, 255, 0.2)',
            'rgba(150, 100, 64, 0.2)', 'rgba(200, 150, 199, 0.2)', 'rgba(83, 150, 255, 0.2)'
        ];

        var borderColors = colors.map(color => color.replace('0.2', '1'));

        var ctx = document.getElementById('taskChart').getContext('2d');
        var taskChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array.from({length: 24}, (v, k) => k + ':00'),
                datasets: [{
                    label: '완료한 작업',
                    data: hourlyData,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                if (value % 1 === 0) {
                                    return value + '건';
                                }
                            },
                            stepSize: 1
                        },
                        max: Math.max(...hourlyData) + 1 // 데이터의 최대값보다 1 큰 값으로 설정
                    }
                }
            }
        });

        // 완료된 작업과 미완료된 작업의 수를 계산
        var completedTasksCount = {{ completed_tasks|length }};
        var totalTasksCount = {{ total_tasks }};
        var incompleteTasksCount = totalTasksCount - completedTasksCount;

        // 메시지 표시
        var messageElement = document.getElementById('completionMessage');
        if (completedTasksCount === 0) {
            messageElement.textContent = "큰 목표를 이루고 싶으면 허락을 구하지 마라. – 미상";
        } else if (completedTasksCount === 1) {
            messageElement.textContent = "상황을 가장 잘 활용하는 사람이 가장 좋은 상황을 맞는다. – 존 우든";
        } else if (completedTasksCount === 2) {
            messageElement.textContent = "창조적인 삶을 살려면 내가 틀릴지도 모른다는 공포를 버려야 한다. – 미상";
        } else if (completedTasksCount === 3) {
            messageElement.textContent = "일반적인 것을 잃을 위험을 감수하지 않으면 평범한 것에 만족해야 한다. – 짐 론";
        } else if (completedTasksCount === 4) {
            messageElement.textContent = "신뢰의 이유는 안전하거나 확실해서가 아니라, 위험을 감수할 용의가 있어서이다. – 미상";
        } else if (completedTasksCount === 5) {
            messageElement.textContent = " 한 가지 생각을 선택하라. 그 생각을 당신의 삶으로 만들어라. 그걸 생각하고, 꿈꾸고, 그에 기반해서 살아가라. 당신의 몸의 모든 부분, 뇌, 근육, 신경을 그 생각으로 가득 채우고 다른 생각은 다 내버려둬라. 이것이 성공하는 방법이다. – 스와미 비베카난다";
        } else if (completedTasksCount === 6) {
            messageElement.textContent = "추구할 수 있는 용기가 있다면 우리의 모든 꿈은 이뤄질 수 있다. – 월트 디즈니";
        } else if (completedTasksCount === 7) {
            messageElement.textContent = "창조적인 삶을 살려면 내가 틀릴지도 모른다는 공포를 버려야 한다. – 미상";
        } else if (completedTasksCount === 8) {
            messageElement.textContent = "기다리는 사람에게 좋은 일이 생기지만, 찾아나서는 사람에게는 더 좋은 일이 생긴다. – 미상";
        } else if (completedTasksCount === 9) {
            messageElement.textContent = "창조적인 삶을 살려면 내가 틀릴지도 모른다는 공포를 버려야 한다. – 미상";
        } else if (completedTasksCount === 10) {
            messageElement.textContent = "늘 하던 대로 하면 늘 얻던 것을 얻는다. – 미상";
        } else if (completedTasksCount === 11) {
            messageElement.textContent = "열정을 잃지 않고 실패에서 실패로 걸어가는 것이 성공이다. – 윈스턴 처칠";
        } else if (completedTasksCount === 12) {
            messageElement.textContent = "애벌레가 세상이 끝났다고 생각하는 순간 나비로 변했다. - 속담";
        } else if (completedTasksCount === 13) {
            messageElement.textContent = "성공한 사업가들은 긍정적인 에너지를 주는 사람들이지 가져가는 사람들이 아니다. – 미상";
        } else if (completedTasksCount === 14) {
            messageElement.textContent = "성공한 사람을 볼 때 당신은 대중에게 드러난 영예만 보지, 절대 그 영예를 얻기 위해 했던 개인적 희생은 보지 않는다. – 바입하브 샤";
        } else if (completedTasksCount === 15) {
            messageElement.textContent = "기회는 일어나는 것이 아니라 만들어내는 것이다. – 크리스 그로서";
        } else if (completedTasksCount === 16) {
            messageElement.textContent = "성공한 사람이 되려고 노력하기보다 가치있는 사람이 되려고 노력하라. – 알버트 아인슈타인";
        } else if (completedTasksCount === 17) {
            messageElement.textContent = "위대한 정신을 가진 사람들은 생각을 논한다. 평범한 사람들은 사건을 논한다. 마음이 좁은 사람들은 사람들을 논한다. – 엘리너 루즈벨트";
        } else {
            messageElement.textContent = "할 일을 모두 끝내셨군요! 고생많으셨어요 :) 오늘 하루도 당신이 있어서 빛났어요. 고마워요!";
        }

        // 삭제 확인 모달 창 기능
        function confirmDelete(title) {
            document.getElementById('deleteTaskTitle').value = title;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        document.getElementById('cancelDelete').onclick = function() {
            document.getElementById('deleteModal').classList.add('hidden');
        };

        // 30분(1800초) 후에 알림을 표시하는 함수
        setTimeout(function() {
            alert("오래 앉아있었습니다. 스트레칭을 해주세요");
        }, 1800000); // 1800000ms = 30분

        // 힘들때 보는 것 페이지를 새 창으로 여는 함수
        function openRandomImage() {
            window.open('/random_image', '_blank', 'width=600,height=400');
        }

        // 전체 초기화하기 기능
        function resetAllTasks() {
            if (confirm("모든 작업을 초기화하시겠습니까?")) {
                fetch('{{ url_for('reset_all_tasks') }}', {
                    method: 'POST',
                }).then(() => window.location.reload());
            }
        }

        // 완료된 작업 토글 기능
        function toggleCompletedTasks() {
            const container = document.getElementById('completedTasksContainer');
            container.classList.toggle('hidden');
        }

        // 페이지 로딩이 완료되면 로딩 스피너를 숨기고 콘텐츠를 표시
        window.onload = function() {
            document.getElementById('loader-container').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }
    </script>
</body>
</html>